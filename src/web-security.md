# web security

## 使用JWT做鉴权

JWT的安全性保证是通过**数字签名**来保证信息的**完整性**和**真实性**。签名部分使用密钥对Header和Payload进行哈希或加密计算的结果。这个密钥必须严格保密，只有服务器知道，不能被泄漏给客户端或任意第三方

JWT的鉴权过程是，客户端使用身份信息登录服务器，然后服务器生成JWT的token返回给客户端，这一过程如果在传送中途或者在客户端被攻击者截获，那么攻击者可以冒充客户端和服务器交互，解决方法如下

- 传输层使用TLS(Transport Layer Security，传输层安全协议，是SSL协议的后继者)。可以防止攻击者进行嗅探或JWT
- JWT令牌的合理管理
  - 缩短令牌的有效期
    - 将访问令牌的有效期设置的足够短
    - 为了防止频繁登录使用刷新令牌
      - Access Token：有效时间短
      - Refresh Token：有效时间长，访问令牌过期后可以拿刷新令牌去请求访问令牌
  - 将令牌存储到合适的地方
    - 不在本地存储中存，例如localStorage或者sessionStorage
    - 使用HttpOnly Cookies
      - HttpOnly属性，浏览器的JS无法通过`document.cookie`等方式获取cookie
      - Secure属性，只在HTTPS中传输cookie
      - SameSite属性，设置为 Strict 或 Lax
- 服务端可以引入令牌黑名单
- 服务端可以在令牌中加入指纹，例如客户端的具体消息，但是这样做的弊端是依然可以被仿制，挑选合适的标识符比较困难

TLS的握手过程（大致）

1. 客户端发起连接（Client Hello），客户端向服务器发送一个“你好”（Client Hello）消息，请求建立安全连接，并告知服务器它支持的**加密算法**和**TLS版本**
2. 服务器响应并发送证书（Server Hello），服务器收到请求后，会回复一个“你好”（Server Hello）消息。在这个消息中，服务器会附带将自己的数字证书（或证书链）发送给客户端。 这个证书包含了**服务器的公钥、域名信息以及证书颁发机构的数字签名**等
3. 客户端验证证书。客户端收到服务器发来的证书后，会立即进行验证。验证过程主要包括：
   1. 证书是否过期？
   2. 域名是否匹配？ （证书上的域名是否与当前访问的网站域名一致）
   3. 证书是否由可信的证书颁发机构（CA）签发？ （客户端的操作系统和浏览器都内置了一个可信的根证书列表。如果服务器证书是由列表中的某个 CA 签发的，那么客户端就认为它可信。）
4. 建立加密通道。如果证书验证成功，客户端和服务器会利用证书中的公钥以及其他握手信息，协商生成一个会话密钥（Session Key）。此后，所有通信都将使用这个密钥进行对称加密，从而确保数据的机密性和完整性
